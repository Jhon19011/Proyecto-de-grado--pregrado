<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-box-seam"></i>
                {{ esPrincipal ? 'Inventario Principal' : 'Inventario Secundario' }}
            </h4>
            <button class="btn btn-outline-light btn-sm" routerLink="/inventarios">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </div>

        <div class="card-body">
            <!-- Tabla principal -->
            <div class="table-responsive">
                <table class="table align-middle table-hover text-center">
                    <thead class="table-primary">
                        <tr>
                            <th>#</th>
                            <th>Nombre Sustancia</th>
                            <th>Cantidad</th>
                            <th>Unidad</th>
                            <th>Remanente</th>
                            <th>Ubicación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of sustanciasAsignadas; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>{{ item.nombreComercial }}</td>
                            <td>{{ item.cantidad }}</td>
                            <td>{{ item.unidad }}</td>
                            <td>{{ item.cantidadremanente }}</td>
                            <td>{{ item.ubicaciondealmacenamiento }}</td>
                            <td>
                                <!-- Acciones dinámicas -->
                                <ng-container *ngIf="esPrincipal; else secundarioBtns">
                                    <!-- Principal -->
                                    <button class="btn btn-sm btn-outline-success mx-1" (click)="abrirMovimientos(item)"
                                        title="Trasladar a inventario secundario">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-warning mx-1" (click)="abrirMovimientos(item)"
                                        title="Prestar sustancia a usuario">
                                        <i class="bi bi-person-check"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-info mx-1" (click)="abrirMovimientos(item)"
                                        title="Ver historial de movimientos">
                                        <i class="bi bi-clock-history"></i>
                                    </button>
                                </ng-container>

                                <ng-template #secundarioBtns>
                                    <!-- Secundario -->
                                    <button class="btn btn-sm btn-outline-primary mx-1" (click)="abrirMovimientos(item)"
                                        title="Registrar entrada">
                                        <i class="bi bi-box-arrow-in-down"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-danger mx-1" (click)="abrirMovimientos(item)"
                                        title="Registrar salida">
                                        <i class="bi bi-box-arrow-up"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-info mx-1" (click)="abrirMovimientos(item)"
                                        title="Ver historial">
                                        <i class="bi bi-clock-history"></i>
                                    </button>
                                </ng-template>

                                <button class="btn btn-sm btn-outline-success mx-1" (click)="abrirTraslado(item)"
                                    title="Trasladar a inventario secundario">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>


                                <button class="btn btn-sm btn-outline-secondary mx-1" (click)="abrirEdicion(item)"
                                    title="Editar asignación">
                                    <i class="bi bi-pencil-square"></i>
                                </button>

                                <button class="btn btn-sm btn-outline-dark mx-1"
                                    (click)="eliminarAsignacion(item.idinventario_sustancia)"
                                    title="Eliminar asignación">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Botón para agregar nuevas sustancias (solo principal) -->
            <div class="text-end mt-3" *ngIf="esPrincipal">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAsignacion">
                    <i class="bi bi-plus-circle"></i> Asignar nueva sustancia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Registrar movimiento -->
<div class="modal fade" id="modalMov" tabindex="-1" aria-labelledby="modalMovLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalMovLabel">
                    Movimientos de {{ movimientoSeleccionado?.nombre_sustancia || '---' }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <ng-container *ngIf="movimientoSeleccionado">

                    <form *ngIf="movimientoSeleccionado" (ngSubmit)="registrarMovimiento()">

                        <div class="mb-3">
                            <label class="form-label">Tipo de movimiento:</label>
                            <select class="form-select" [(ngModel)]="movimientoSeleccionado.tipo" name="tipo" required>
                                <option value="entrada">Entrada</option>
                                <option value="salida">Salida</option>
                                <option *ngIf="esPrincipal" value="prestamo">Préstamo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cantidad:</label>
                            <input type="number" class="form-control" [(ngModel)]="movimientoSeleccionado.cantidad"
                                name="cantidad" min="1" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Motivo:</label>
                            <textarea class="form-control" [(ngModel)]="movimientoSeleccionado.motivo" name="motivo"
                                rows="2" required></textarea>
                        </div>

                        <div class="mb-3" *ngIf="esPrincipal">
                            <label class="form-label">Usuario (si aplica):</label>
                            <input type="text" class="form-control" [(ngModel)]="movimientoSeleccionado.usuario"
                                name="usuario" placeholder="Nombre o ID del usuario" />
                        </div>

                        <button class="btn btn-primary w-100" type="submit"
                            [disabled]="!movimientoSeleccionado.cantidad || !movimientoSeleccionado.motivo">
                            <i class="bi bi-save"></i> Registrar movimiento
                        </button>
                    </form>

                    <hr />
                    <h6 class="fw-bold text-primary mt-3">Historial</h6>
                    <div class="table-responsive" *ngIf="movimientos && movimientos.length > 0; else sinHistorial">
                        <table class="table table-sm table-bordered text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let m of movimientos">
                                    <td>{{ m.fecha | date: 'short' }}</td>
                                    <td>
                                        <span class="badge" [ngClass]="{
                        'bg-success': m.tipo === 'entrada',
                        'bg-danger': m.tipo === 'salida',
                        'bg-warning text-dark': m.tipo === 'prestamo'
                      }">
                                            {{ m.tipo | titlecase }}
                                        </span>
                                    </td>
                                    <td>{{ m.cantidad }}</td>
                                    <td>{{ m.motivo }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <ng-template #sinHistorial>
                        <p class="text-muted text-center">No hay movimientos registrados.</p>
                    </ng-template>
                </ng-container>

                <ng-template [ngIf]="!movimientoSeleccionado">
                    <p class="text-center text-muted">
                        Cargando datos del movimiento...
                    </p>
                </ng-template>
            </div>
        </div>
    </div>
</div>


<!-- MODAL: Editar asignación -->
<div class="modal fade" id="modalEdicion" tabindex="-1" aria-labelledby="modalEdicionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="modalEdicionLabel">Editar asignación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form *ngIf="asignacionSeleccionada" (ngSubmit)="guardarEdicion()">
                    <div class="mb-3">
                        <label class="form-label">Cantidad:</label>
                        <input type="number" class="form-control" [(ngModel)]="asignacionSeleccionada.cantidad"
                            name="cantidad" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remanente:</label>
                        <input type="number" class="form-control" [(ngModel)]="asignacionSeleccionada.cantidadremanente"
                            name="remanente" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gasto total:</label>
                        <input type="number" class="form-control" [(ngModel)]="asignacionSeleccionada.gastototal"
                            name="gasto" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicación:</label>
                        <input type="text" class="form-control"
                            [(ngModel)]="asignacionSeleccionada.ubicaciondealmacenamiento" name="ubicacion" required />
                    </div>
                    <button class="btn btn-success w-100" type="submit">
                        <i class="bi bi-save"></i> Guardar cambios
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- MODAL: Nueva asignación -->
<div class="modal fade" id="modalAsignacion" tabindex="-1" aria-labelledby="modalAsignacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalAsignacionLabel">
                    Asignar nueva sustancia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="asignarSustancia()">
                    <div class="mb-3">
                        <label class="form-label">Sustancia:</label>
                        <select class="form-select" [(ngModel)]="sustancia" name="sustancia" required>
                            <option *ngFor="let s of sustanciasDisponibles" [value]="s.idsustancia">
                                {{ s.nombreComercial }}
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cantidad:</label>
                        <input type="number" class="form-control" [(ngModel)]="cantidad" name="cantidad" min="1"
                            required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cantidad remanente:</label>
                        <input type="number" class="form-control" [(ngModel)]="cantidadremanente"
                            name="cantidadremanente" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gasto total:</label>
                        <input type="number" class="form-control" [(ngModel)]="gastototal" name="gastototal" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicación de almacenamiento:</label>
                        <input type="text" class="form-control" [(ngModel)]="ubicaciondealmacenamiento" name="ubicacion"
                            required />
                    </div>
                    <button class="btn btn-success w-100" type="submit">
                        <i class="bi bi-check-circle"></i> Asignar sustancia
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Trasladar a inventario secundario -->
<div class="modal fade" id="modalTraslado" tabindex="-1" aria-labelledby="modalTrasladoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalTrasladoLabel">
                    Trasladar sustancia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="confirmarTraslado()">
                    <div class="mb-3">
                        <label class="form-label">Inventario destino:</label>
                        <select class="form-select" [(ngModel)]="inventarioDestino" name="destino" required>
                            <option *ngFor="let inv of inventariosSecundarios" [value]="inv.idtablas">
                                {{ inv.nombretabla }}
                            </option>
                        </select>

                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cantidad a trasladar:</label>
                        <input type="number" class="form-control" [(ngModel)]="cantidadTraslado" name="cantidad" min="1"
                            required />
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-arrow-left-right"></i> Confirmar traslado
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>